= Structured logging with SLF4J and Logback
:published_at: 2017-12-01
:hp-tags: java
:hp-image: /images/logos/slf4j.png

== Structured logging with SLF4J

All Java developpers know how to log a message:
[source,java]
----
Logger demoLogger = LoggerFactory.getLogger("logodissey.DemoLogger");
demoLogger.info("Hello world!");
----

Properly configured, it produces a log like
[source]
----
21:10:29.178 [Thread-1] INFO  logodissey.DemoLogger - Hello world!
----
Notice, this "Hello world!" message is qualified with several fields:

* Timestamp
* Thread Id
* Level
* Logger/Category

We can add more contextual information to this list, and give more detail about what was going on when this log was printed. For instance, to log the user Id, let's use the MDC (Mapped Diagnostic Context) to set more data in the log:
[source,java]
----
MDC.put("userId", "gquintana");
demoLogger.info("Hello world!");
MDC.remove("userId");
----
With the suitable configuration, we can get the user Id the log:
[source]
----
21:10:29.178 [Thread-1] gquintana INFO  logodissey.DemoLogger - Hello world!
----
The `MDC.remove` (or `MDC.clear`) call is necessary to clean the MDC after usage and avoid leaving information for later logs.
To avoid forgetting to do housekeeping afterwards, we can use a try-with-resource:
[source,java]
----
try(MDC.MDCCloseable mdc = MDC.putCloseable("user", "gquintana")) {
	demoLogger.info("Hello world!");
}
----
Hopefully, this kind of code won't make its way in your business code because, it is usually hidden in an interceptor like a Servlet filter, a Spring aspect. In Logback, there is a `MDCInsertingServletFilter` class which can be used as an example.

The MDC can store information about the user (user Id, session Id, token Id), about the current request (request Id, transaction Id), about long running threads (batch instance Id, broker client Id). 
Later on, this information will be part of the log.

By the way, as the MDC is usually stored as a thread local variable.
This means two things:

1. It must be properly cleaned after being used, or you may experience information leaks if the thread is reused (thread pools).
2. The information may no be properly transfered from thread to another. Think about asynchronous calls.

== JSON logging with Logback contrib



== JSON logging with Logback Logstash layout


