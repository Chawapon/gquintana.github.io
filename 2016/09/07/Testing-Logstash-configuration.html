<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Testing Logstash configuration - JRald</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Testing Logstash configuration">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Testing Logstash configuration">
    <meta property="og:description" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">

    <link rel="stylesheet" type="text/css" href="//gquintana.github.io/themes/uno/assets/css/uno.css?v=1475787264099" />

    <link rel="canonical" href="https://gquintana.github.io/2016/09/07/Testing-Logstash-configuration.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="JRald" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Testing Logstash configuration" />
    <meta property="og:description" content="You wrote a piece of Logstash configuration which can parse some logs. You tested several corner cases to ensure the output in Elasticsearch was alright. How do you protect this clever configuration file against regressions? Unit testing to the rescue of course! Simple example For the sake of simplicity, we" />
    <meta property="og:url" content="https://gquintana.github.io/2016/09/07/Testing-Logstash-configuration.html" />
    <meta property="article:tag" content="logstash" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Testing Logstash configuration" />
    <meta name="twitter:description" content="You wrote a piece of Logstash configuration which can parse some logs. You tested several corner cases to ensure the output in Elasticsearch was alright. How do you protect this clever configuration file against regressions? Unit testing to the rescue of course! Simple example For the sake of simplicity, we" />
    <meta name="twitter:url" content="https://gquintana.github.io/2016/09/07/Testing-Logstash-configuration.html" />
    
    <script type="application/ld+json">
null
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="JRald" href="https://gquintana.github.io/rss/" />

</head>
<body class="post-template tag-logstash no-js">

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed " >
      <div class="panel-main">
    
        <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
    
            <h1 class="panel-cover__title panel-title"><a href="https://gquintana.github.io" title="link to homepage for JRald">JRald</a></h1>
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description">Yet another blog about tech stuff</p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />
    
            <div class="navigation-wrapper">
    
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="https://gquintana.github.io/#blog" title="link to JRald blog" class="blog-button">Blog</a></li>
                </ul>
              </nav>
    
              
              
              <nav class="cover-navigation navigation--social">
                <ul class="navigation">
              
              
                  <!-- Twitter -->
                  <li class="navigation__item">
                    <a href="gerald_quintana" title="Twitter account">
                      <i class='icon icon-social-twitter'></i>
                      <span class="label">Twitter</span>
                    </a>
                  </li>
              
              
                  <!-- Github -->
                  <li class="navigation__item">
                    <a href="gquintana" title="Github account">
                      <i class='icon icon-social-github'></i>
                      <span class="label">Github</span>
                    </a>
                  </li>
                  </li>
              
              
              
              
              
              
                </ul>
              </nav>
              
    
            </div>
    
          </div>
    
        </div>
    
        <div class="panel-cover--overlay"></div>
      </div>
    </header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="07 Sep 2016" class="post-meta__date date">07 Sep 2016</time> &#8226; <span class="post-meta__tags tags">on <a href="https://gquintana.github.io/tag/logstash/">logstash</a></span>
        <span class="post-meta__author author"><img src="https://avatars.githubusercontent.com/u/755587?v&#x3D;3" alt="profile image for Gerald Quintana" class="avatar post-meta__avatar" /> by Gerald Quintana</span>
      </div>
      <h1 class="post-title">Testing Logstash configuration</h1>
    </header>

    <section class="post tag-logstash">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>You wrote a piece of Logstash configuration which can parse some logs.
You tested several corner cases to ensure the output in Elasticsearch was alright.
How do you protect this clever configuration file against regressions?</p>
</div>
<div class="paragraph">
<p>Unit testing to the rescue of course!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_example">Simple example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the sake of simplicity, we will take an obvious example: access logs.
The input looks like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>172.17.0.1 - - [05/Sep/2016:20:06:17 +0000] "GET /images/logos/hubpress.png HTTP/1.1" 200 5432 "http://localhost/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/51.0.2704.79 Chrome/51.0.2704.79 Safari/537.36" "-"</pre>
</div>
</div>
<div class="paragraph">
<p>The output, once in Elasticsearch, should look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{ "@version":"1",
  "@timestamp":"2016-09-05T20:06:17.000Z",
  "type":"nginx",
  "host":"nginx-server", "path":"/var/log/nginx/access.log",
  "clientip":"172.17.0.1", "ident":"-", "auth":"-",
  "verb":"GET","request":"/images/logos/hubpress.png","httpversion":"1.1",
  "response":200, "bytes":5432, "referrer":"\"http://localhost/\"",
  "agent": "\"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/51.0.2704.79 Chrome/51.0.2704.79 Safari/537.36\""
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration could look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">input {
    file {
        path =&gt; "/var/log/nginx/access*.log"
        type =&gt; "nginx"
    }
}
filter {
    if [type] == "nginx" {
        grok {
            match =&gt; [ "message" , "%{COMBINEDAPACHELOG}"]
        }
        date {
            match =&gt; [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
        }
        mutate {
            convert =&gt; ["response", "integer"]
            convert =&gt; ["bytes", "integer"]
        }
    }
}
output {
    elasticsearch {
      hosts =&gt; [ "es-server"]
      index =&gt; "logstash-%{+YYYY.MM.dd}"
      document_type =&gt; "%{type}"
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_split_the_file">Split the file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the above config file, the interesting part, the one containing logic is the filter part.
In order to test it, the first thing to do is split this big file into small pieces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>01_logstash_input_nginx.conf</code> contains the nginx file input</p>
</li>
<li>
<p><code>02_logstash_filter_nginx.conf</code> contains the nginx filter section</p>
</li>
<li>
<p><code>03_logstash_output.conf</code> contains the elasticsearch output</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In production, you can load multiple config files as if they were a single one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>logstash agent -f /etc/logstash.d/*.conf"</pre>
</div>
</div>
<div class="paragraph">
<p>At test time, by picking a single configuration file <code>02_logstash_filter_nginx.conf</code>, the Nginx log parsing can be tested in isolation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_write_the_unit_test">Write the unit test</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s test the <code>02_logstash_filter_nginx.conf</code> file alone and write a simple Ruby test case.
As you may know, Logstash is written in JRuby.</p>
</div>
<div class="listingblock">
<div class="title">02_logstash_filter_nginx_spec.rb</div>
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># encoding: utf-8
require "logstash/devutils/rspec/spec_helper"

# Load the configuration file
@@configuration = String.new
@@configuration &lt;&lt; File.read("conf/02_logstash_nginx_filter.conf")

describe "Nginx filter" do

  config(@@configuration) <i class="conum" data-value="1"></i><b>(1)</b>

  # Inject input event/message into the pipeline
  message = "172.17.0.1 - - [05/Sep/2016:20:06:17 +0000] \"GET /images/logos/hubpress.png HTTP/1.1\" 200 5432 \"http://localhost/\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/51.0.2704.79 Chrome/51.0.2704.79 Safari/537.36\" \"-\""
  sample("message" =&gt; message, "type" =&gt; "nginx") do <i class="conum" data-value="2"></i><b>(2)</b>
    # Check the ouput event/message properties
    insist { subject.get("type") } == "nginx" <i class="conum" data-value="3"></i><b>(3)</b>
    insist { subject.get("@timestamp").to_iso8601 } == "2016-09-05T20:06:17.000Z"
    insist { subject.get("verb") } == "GET"
    insist { subject.get("request") } == "/images/logos/hubpress.png"
    insist { subject.get("response") } == 200
    insist { subject.get("bytes") } == 5432
    reject { subject.get("tags").include?("_grokparsefailure") }
    reject { subject.get("tags").include?("_dateparsefailure") }
  end
end</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load configuration file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject input event/message into the pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check the ouput event/message properties</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This test uses the JRuby testing framework called RSpec (<code>describe</code> method).
The <code>config</code> and <code>sample</code> functions are located in the <a href="https://github.com/elastic/logstash-devutils">Logstash DevUtils</a> library.
The <code>insist</code> and <code>reject</code> functions are part of the <a href="https://github.com/jordansissel/ruby-insist">Ruby Insist</a> assertion library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_the_unit_tests">Run the unit tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we will need to download and install additional development libraries like those mentioned above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ logstash-2.4.0/bin/logstash-plugin install --development
Installing logstash-devutils, logstash-input-generator, logstash-codec-json, logstash-output-null, logstash-filter-mutate, flores, rspec, stud, pry, rspec-wait, childprocess, ftw, logstash-output-elasticsearch, rspec-sequencing, gmetric, gelf, timecop, jdbc-derby, docker-api, logstash-codec-plain, simplecov, coveralls, longshoreman, rumbster, logstash-filter-kv, logstash-filter-ruby, sinatra, webrick, poseidon, logstash-output-lumberjack, webmock, logstash-codec-line, logstash-filter-grok
Installation successful</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can run the test, Logstash comes with a <code>rspec</code> command to run these spec files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ logstash-2.4.0/bin/rspec 02_logstash_nginx_filter_spec.rb
Using Accessor#strict_set for specs
Run options: exclude {:redis=&gt;true, :socket=&gt;true, :performance=&gt;true, :couchdb=&gt;true, :elasticsearch=&gt;true, :elasticsearch_secure=&gt;true, :export_cypher=&gt;true, :integration=&gt;true, :windows=&gt;true}
.

Finished in 0.115 seconds (files took 0.784 seconds to load)
1 example, 0 failures

Randomized with seed 4384</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>rspec</code> command can also run multiple tests at once.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ logstash-2.4.0/bin/rspec spec -P '**/*_spec.rb'</pre>
</div>
</div>
<div class="paragraph">
<p>To prevent test dependencies, they are randomly ordered: This called randomized testing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_give_me_the_code">Give me the code!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the code shown in this article is available in <a href="https://github.com/gquintana/gquintana.github.io/tree/master/sources/2016-09-07-Testing-Logstash-configuration">Github</a>.</p>
</div>
</div>
</div>
    </section>

  </article>




            <footer class="footer">
                <span class="footer__copyright">&copy; 2016. All rights reserved.</span>
                <span class="footer__copyright"><a href="http://uno.daleanthony.com" title="link to page for Uno Ghost theme">Uno theme</a> by <a href="http://daleanthony.com" title="link to website for Dale-Anthony">Dale-Anthony</a></span>
                <span class="footer__copyright">Proudly published with <a href="http://hubpress.io" title="link to Hubpress website">Hubpress</a></span>
            </footer>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>

    <script type="text/javascript" src="//gquintana.github.io/themes/uno/assets/js/main.js?v=1475787264099"></script>
    

</body>
</html>
